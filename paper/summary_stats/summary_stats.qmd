---
title: "Hansard Summary Statistics"
format: pdf
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(tidyverse)
library(arrow)
library(hrbrthemes)

knitr::opts_chunk$set(dev = "ragg_png")
```

```{r data import}
# data import
corpus <- read_parquet("../../inputs/corpus_1998_to_2025.parquet")
```

```{r filtering}
# filter for just chamber proceedings
corpus <- corpus %>% filter(fedchamb_flag==0)

# get parliament number variable
parl_dates <- ausPH::getParliaments() %>% 
  dplyr::select(PID, Name, DateOpening, ParliamentEnd) %>% 
  # our corpus only goes back to the 38th parliament
  filter(PID>=38)

# add parliament number variable to corpus
corpus <- corpus %>%
  mutate(parliament_num = case_when(
    date >= parl_dates$DateOpening[parl_dates$PID==38] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==38] ~ 38,
    date >= parl_dates$DateOpening[parl_dates$PID==39] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==39] ~ 39,
    date >= parl_dates$DateOpening[parl_dates$PID==40] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==40] ~ 40,
    date >= parl_dates$DateOpening[parl_dates$PID==41] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==41] ~ 41,
    date >= parl_dates$DateOpening[parl_dates$PID==42] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==42] ~ 42,
    date >= parl_dates$DateOpening[parl_dates$PID==43] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==43] ~ 43,
    date >= parl_dates$DateOpening[parl_dates$PID==44] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==44] ~ 44,
    date >= parl_dates$DateOpening[parl_dates$PID==45] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==45] ~ 45,
    date >= parl_dates$DateOpening[parl_dates$PID==46] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==46] ~ 46,
    date >= parl_dates$DateOpening[parl_dates$PID==47] & 
      date <= parl_dates$ParliamentEnd[parl_dates$PID==47] ~ 47,
    date >= parl_dates$DateOpening[parl_dates$PID==48] ~ 48,
    .default = NA))

# filter for just complete parliament periods (39-47)
corpus <- corpus %>% 
  filter(parliament_num >= 39 & parliament_num <= 47)

# correction for some incorrect party affiliations that were identified
corpus <- corpus %>% 
  mutate(partyAbbrev = case_when(
    partyAbbrev=="CLP" ~ "LIB",
    partyAbbrev %in% c("NATS WA", "NAT") ~ "NP",
    .default = partyAbbrev)) %>% 
  mutate(partyName = case_when(
      partyAbbrev=="LIB" ~ "Liberal Party of Australia",
      partyAbbrev=="NP" ~ "The Nationals",
      .default = partyName))
```

## Parliament Dates

```{r}
parl_dates_tbl <- corpus %>% 
  distinct(parliament_num, date) %>% 
  group_by(parliament_num) %>% 
  filter(date==min(date) | date==max(date)) %>% 
  mutate(min_or_max = ifelse(date==min(date), "min", "max")) %>% 
  ungroup() %>% 
  pivot_wider(names_from = min_or_max, values_from = date) %>% 
  rename("Parliament Number"=parliament_num,
         "First Sitting Day" = min,
         "Last Sitting Day" = max)

knitr::kable(parl_dates_tbl)
#write_csv(parl_dates_tbl, "../tables/parliament_dates.csv")
```

## Number of sitting days per parliament

```{r}
n_days_per_parl <- corpus %>% 
  distinct(parliament_num, date) %>% 
  group_by(parliament_num) %>% 
  count(name="Count") %>% 
  ungroup() %>% 
  rename("Parliament Number" = parliament_num)

knitr::kable(n_days_per_parl)
#write_csv(n_days_per_parl, "../tables/n_sitting_days_per_parliament.csv")
```

## Sample of 10 rows for figure 1

```{r}
sample_20250327 <- corpus %>%
  filter(date=="2025-03-27", speech_no==109) %>%
  select(date, name, order, speech_no, partyName, body, gender, interject)

knitr::kable(sample_20250327)
#write_csv(sample_20250327, "../tables/corpus_sample_2025-03-27.csv")
```

## Example of speaking turns

```{r}
# corpus %>% filter(date=="2013-02-14" & speech_no==74) %>%
#   select(date, name, order, speech_no, partyName, body, gender, interject) %>%
#   write_csv("../tables/corpus_sample_speaking_turns.csv")
```

## House of Reps Summary Statistics

```{r}
bind_rows(
  corpus %>% distinct(date) %>% count(name="Value") %>% 
    mutate(Metric="Number of sitting days"),
  corpus %>% distinct(uniqueID) %>% filter(!is.na(uniqueID)) %>% count(name="Value") %>% 
    mutate(Metric="Number of unique speakers"),
  corpus %>% distinct(partyAbbrev) %>% filter(!is.na(partyAbbrev)) %>% count(name="Value") %>% 
    mutate(Metric="Number of unique parties"),
  corpus %>% distinct(electorate) %>% filter(!is.na(electorate)) %>% count(name="Value") %>% 
    mutate(Metric="Number of unique electorates")) %>% 
  select(Metric, Value) %>% 
  knitr::kable()
```

## Number of rows flagged as interjections for House of Reps

```{r}
corpus %>% 
  group_by(interject) %>% 
  count() %>% 
  ungroup() %>% 
  rename("Interjection Flag" = interject) %>% 
  knitr::kable()
```

## Number and proportion of interjections by gender for House of Reps

```{r}
interject_by_gender <- left_join(
  corpus %>% group_by(gender, interject) %>% 
  count() %>% ungroup() %>% filter(interject==1),
  corpus %>% group_by(gender, interject) %>% 
  count() %>% ungroup() %>% filter(interject==1) %>% 
  mutate(prop_interject = 100*(n/sum(n))) %>% 
  mutate(prop_interject=round(prop_interject,2),
         prop_interject = paste0(prop_interject,"%")) ) %>% 
  select(Gender=gender, Count=n, Proportion=prop_interject) %>% 
  mutate(Gender=str_to_sentence(Gender)) 

#write_csv(interject_by_gender, "tables/interject_by_gender.csv")
knitr::kable(interject_by_gender)
```

## Number of interjections by political party

```{r}
corpus %>% 
  filter(interject==1 & !is.na(partyName)) %>% 
  group_by(partyName) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  rename(`Party Name`=partyName) %>% 
  knitr::kable()
```

## Rate of interjections by political party and gender

```{r}
# get count of unique speakers per party by gender
n_speakers_by_sex_and_party <- corpus %>% 
  distinct(gender, partyName, displayName) %>% 
  filter(!is.na(gender)) %>% 
  group_by(gender, partyName) %>% 
  count() %>% 
  ungroup() %>% 
  pivot_wider(names_from = gender, values_from = n) %>% 
  mutate(across(c(female, male), ~ifelse(is.na(.x), 0, .x))) %>% 
  pivot_longer(c(female, male), names_to = "gender", values_to = "n_mps")

# Count total interjections by gender and party
interject_by_gender_party <- corpus %>%
  filter(interject == 1, !is.na(partyName), !is.na(gender)) %>%
  group_by(partyName, gender) %>%
  summarise(n_interjects = n(), .groups = "drop") %>%
  group_by(partyName) %>%
  mutate(
    total_interjects = sum(n_interjects),
    pct_of_total = 100 * n_interjects / total_interjects
  ) %>%
  ungroup() %>%
  left_join(n_speakers_by_sex_and_party, by = c("gender", "partyName")) %>%
  mutate(rate_of_interject = n_interjects / n_mps) %>%
  select(partyName, gender, rate_of_interject, pct_of_total) %>%
  pivot_wider(
    names_from = gender, 
    values_from = c(rate_of_interject, pct_of_total),
    names_sep = "_"
  ) %>%
  mutate(across(c(rate_of_interject_female,rate_of_interject_male,
                  pct_of_total_female,pct_of_total_male), 
                ~ifelse(is.na(.x), 0, .x))) %>% 
  rename(
    `Party Name` = partyName,
    Women = rate_of_interject_female,
    Men = rate_of_interject_male,
    pct_women = pct_of_total_female,
    pct_men = pct_of_total_male
  ) %>%
  mutate(
    across(c(Women, Men), ~round(.x, 2)),
    across(c(pct_women, pct_men), ~round(.x, 1)),
    Women = paste0(Women, " (", pct_women, "%)"),
    Men = paste0(Men, " (", pct_men, "%)")
  ) %>%
  select(`Party Name`, Women, Men) %>%
  arrange(`Party Name`)


# interject_by_gender_party <- corpus %>%
#   filter(interject==1 & !is.na(partyName)) %>%
#   group_by(partyName, gender) %>%
#   count() %>%
#   ungroup() %>%
#   left_join(n_speakers_by_sex_and_party, by=c("gender","partyName")) %>% 
#   mutate(rate_of_interject = n/n_mps) %>% 
#   select(-n, -n_mps) %>% 
#   pivot_wider(names_from = gender, values_from = rate_of_interject) %>%
#   rename(`Party Name`=partyName, Women=female, Men=male) %>%
#   mutate(across(c(Women, Men), ~ifelse(is.na(.x), 0, .x))) %>%
#   mutate("Total"=Women+Men,
#          prop_men = paste0(round((Men/Total)*100, 2), "%"),
#          prop_women = paste0(round((Women/Total)*100, 2), "%")) %>%
#   mutate(across(c(Women, Men), ~round(.x, 2))) %>% 
#   mutate(Women = paste0(Women, " (", prop_women, ")"),
#          Men = paste0(Men, " (", prop_men, ")")) %>% 
#   select(-prop_men, -prop_women, -Total) %>% 
#   arrange(`Party Name`)

knitr::kable(interject_by_gender_party)

# write_csv(interject_by_gender_party, "../tables/interject_by_gender_and_party.csv")
```

```{r}
# get count of unique speakers per party by gender
n_speakers_by_sex_and_party <- corpus %>% 
  distinct(gender, partyName, displayName) %>% 
  filter(!is.na(gender)) %>% 
  group_by(gender, partyName) %>% 
  count() %>% 
  ungroup() %>% 
  pivot_wider(names_from = gender, values_from = n) %>% 
  mutate(across(c(female, male), ~ifelse(is.na(.x), 0, .x))) %>% 
  pivot_longer(c(female, male), names_to = "gender", values_to = "n_mps")
```

## Average, standard deviation, minimum and maximum speech length (by number of words)

```{r}
speech_length_stats <- corpus %>% 
  group_by(speech_no, date) %>% 
  # add 1 because counting number of spaces
  summarise(speech_length = sum(str_count(body, "\\s+")+1)) %>% 
  ungroup()

speech_length_stats_tbl <- speech_length_stats %>% 
  summarise(mean_speech_length = mean(speech_length, na.rm=T),
            min_speech_length = min(speech_length, na.rm=T),
            max_speech_length = max(speech_length, na.rm=T),
            sd_speech_length = sd(speech_length, na.rm=T)) %>% 
  pivot_longer(c(mean_speech_length:last_col()), names_to = "Metric", values_to = "Value") %>% 
    mutate(Value = round(Value, 2),
         Metric = case_when(
           Metric=="min_speech_length" ~ "Minimum",
           Metric=="max_speech_length" ~ "Maximum",
           Metric=="mean_speech_length" ~ "Average",
           Metric=="sd_speech_length" ~ "Standard Deviation")) 

#write_csv(speech_length_stats_tbl, "../tables/speech_length_stats.csv")

speech_length_stats_tbl %>% knitr::kable()
```

## Number of sitting days, per year for House of Reps

```{r}
corpus %>% 
  distinct(date) %>% 
  mutate(year = str_extract(date, "^\\d{4}")) %>% 
  group_by(year) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(year = as.numeric(year)) %>% 
  ggplot(aes(x=year, y=n)) +
  geom_col(fill="#66CC99") +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=15)) +
  labs(x="Year", y="Number of sitting days",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(axis.title.x = element_text(hjust = 0.5),
         axis.title.y = element_text(hjust = 0.5))

ggsave("../images/n_sitting_days_per_year.png",  width=8, height=5)
```

## Number of unique speakers per day

```{r}
corpus %>% 
  filter(!is.na(displayName)) %>% 
  distinct(date, displayName) %>% 
  group_by(date) %>% 
  count() %>%
  ggplot(aes(x=date, y=n)) +
  geom_point(alpha=0.5, color="#66CC99") +
  theme_bw() +
  theme(legend.position = "none",
        text = element_text(size=15)) +
  labs(x="Day", y="Number of unique speakers",
     #  title = "Number of unique speakers per day",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(axis.title.x = element_text(hjust = 0.5),
         axis.title.y = element_text(hjust = 0.5))

ggsave("../images/n_unique_speakers_per_day.png", width=8, height=5)
```

## Number of unique women and men speakers, per day

```{r}
corpus %>% 
  filter(!is.na(displayName)) %>% 
  distinct(date, displayName, gender) %>% 
  group_by(date, gender) %>% 
  count() %>%
  mutate(gender = case_when(gender=="female"~"Women",
                       gender=="male"~"Men")) %>% 
  ggplot(aes(x=date, y=n, color=gender)) +
  geom_point(alpha=0.5) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  labs(x="Day", y="Number of unique speakers by gender", color="Gender",
     #  title = "Number of unique speakers per day",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(
     text=element_text(size=15),
     axis.title.x = element_text(hjust = 0.5, size=12),
     axis.title.y = element_text(hjust = 0.5, size=12),
     legend.position = "bottom") +
  scale_color_manual(values=c("#66CC99", "#B0AFFF"))

ggsave("../images/n_unique_speakers_per_day_gender.png", width=8, height=5)
```

## Number of unique women and men speakers, per year

```{r}
corpus %>% 
  mutate(year = as.numeric(str_extract(date, "^\\d{4}"))) %>% 
  distinct(displayName, gender, year) %>% 
  filter(!is.na(gender)) %>% 
  mutate(gender = case_when(gender=="female"~"Women",
                       gender=="male"~"Men")) %>% 
  group_by(year, gender) %>% 
  count() %>% 
  ggplot(aes(x=year, y=n, color = gender)) +
  geom_line() +
  geom_point() +
  theme_bw() +
  theme(text=element_text(size=15)) +
  labs(x="Year", y="Number of unique speakers", color="Gender",
      # title = "Number of unique speakers by gender per year",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(axis.title.x = element_text(hjust = 0.5),
         axis.title.y = element_text(hjust = 0.5),
         legend.position = "bottom") +
  scale_color_manual(values=c("#66CC99", "#B0AFFF"))

ggsave("../images/n_speakers_per_yr_gender.png", width=8, height=5)
```

## Number of unique speeches, per day for House of Reps

```{r}
corpus %>% 
  distinct(date, speech_no) %>% 
  group_by(date) %>% 
  count() %>% 
  ungroup() %>% 
  ggplot(aes(x=date, y=n))+
  geom_point(alpha=0.5, colour="#66CC99") +
  theme_bw()+
  theme(legend.position = "none") +
  labs(x="Date", y="Number of speeches",
      # title = "Number of speeches per day",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(axis.title.x = element_text(hjust = 0.5),
         axis.title.y = element_text(hjust = 0.5))
```

## Number of interjections by year for House of Reps

```{r}
corpus %>% 
  select(date, interject) %>% 
  mutate(year = as.numeric(str_extract(date, "^\\d{4}"))) %>% 
  group_by(year, interject) %>% 
  count() %>% 
  ungroup() %>% 
  filter(interject==1) %>% 
  ggplot(aes(x=year, y=n)) +
  geom_col(fill="#66CC99") +
  theme_bw() +
  theme(legend.position = "none",
        text=element_text(size=15))+
  labs(x="Year", y="Number of interjections",
      # title = "Number of interjections per year",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(axis.title.x = element_text(hjust = 0.5),
         axis.title.y = element_text(hjust = 0.5))

ggsave("../images/n_interject_per_yr.png", width=8, height=5)
```

## Number of interjections by day for House of Reps

```{r}
corpus %>% 
  select(date, interject) %>% 
  group_by(date, interject) %>% 
  count() %>% 
  ungroup() %>% 
  filter(interject==1) %>% 
  ggplot(aes(x=date, y=n)) +
  geom_point(alpha=0.5, color="#66CC99") +
  theme_bw() +
  theme(legend.position = "none")+
  labs(x="Date", y="Number of interjections",
      # title = "Number of interjections per day",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(axis.title.x = element_text(hjust = 0.5),
         axis.title.y = element_text(hjust = 0.5))
```

## Number of interjections per day and speaker, by gender for House of Reps

```{r}
# get count of unique speakers per day by gender
n_speakers_by_sex <- corpus %>% 
  distinct(date, gender, displayName) %>% 
  filter(!is.na(gender)) %>% 
  group_by(date, gender) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(gender = case_when(gender=="female"~"Women",
                       gender=="male"~"Men")) %>% 
  rename(n_present_total = n)

corpus %>% 
  select(date, gender, interject) %>% 
  mutate(gender = case_when(gender=="female"~"Women",
                       gender=="male"~"Men")) %>% 
  group_by(date, interject, gender) %>% 
  count() %>% 
  ungroup() %>% 
  filter(interject==1, !is.na(gender)) %>% 
  left_join(n_speakers_by_sex, by= c("date","gender")) %>% 
  mutate(prop = (n/n_present_total)) %>% 
  ggplot(aes(x=date, y=prop, color=gender)) +
  geom_point(alpha=0.5) +
  geom_smooth(method = "loess", alpha=1, show.legend = F) +
  theme_bw() +
  theme(text=element_text(size=15))+
  labs(x="Day", y="Interjections per speaker", colour="Gender",
       #title = "Number of interjections per day",
       caption = "Note: Proceedings captured are from November 1998 to March 2025.") +
  hrbrthemes::theme_ipsum() +
   theme(
     text=element_text(size=15),
     axis.title.x = element_text(hjust = 0.5, size=12),
     axis.title.y = element_text(hjust = 0.5, size=12),
     legend.position = "bottom") +
  scale_color_manual(values=c("Men"="#66CC99", "Women"="#B0AFFF"))


ggsave("../images/n_interject_per_day_gender.png", width=8, height=5)
```

## Gender composition in parliament and rate of interjections by gender

```{r}
women_mps_stats <- read_csv("../../data/women_mps_stats.csv", show_col_types = F) %>% 
  pivot_longer(c(Women, Men), names_to = "gender", values_to = "pct_in_parliament") %>% 
  mutate(Parliament = as.numeric(str_remove(Parliament, " \\(\\d{4}\\)")))

n_interject_parliament <- corpus %>% 
  filter(!is.na(gender), interject==1) %>% 
  group_by(gender, parliament_num) %>% 
  count(name="n_interject") %>% 
  ungroup() %>% 
  rename(Parliament = parliament_num) %>% 
  mutate(gender = ifelse(gender=="female", "Women", "Men"))

n_mps_gender_parliament <- corpus %>% 
    distinct(gender, displayName, parliament_num) %>% 
    filter(!is.na(gender)) %>% 
  group_by(gender, parliament_num) %>% 
  count(name="n_mps") %>% 
  ungroup() %>% 
  rename(Parliament = parliament_num) %>% 
  mutate(gender = ifelse(gender=="female", "Women", "Men"))

women_mps_stats_plot <- left_join(women_mps_stats, n_interject_parliament, by=c("Parliament","gender")) %>% 
  left_join(., n_mps_gender_parliament, by=c("Parliament","gender")) %>% 
  mutate(rate_of_interject = n_interject/n_mps) %>% 
  select(-c(n_interject, -n_mps))

women_mps_stats_plot
```

```{r}
ggplot(women_mps_stats_plot, aes(x=Parliament)) +
  geom_col(aes(y=pct_in_parliament, fill=gender), position="dodge") +
  geom_line(aes(y=rate_of_interject, color=gender)) +
  scale_y_continuous(
    name = "% of MPs in Parliament",  # left y-axis
    sec.axis = sec_axis(~ . ,
                        name = "Rate of interjections per speaker")) +
  hrbrthemes::theme_ipsum() +
  scale_fill_manual(values=c("Men"="#66CC99", "Women"="#B0AFFF")) +
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        axis.title.y.right = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=c(39,40,41,42,43,44,45,46,47))
```

## Analysis Dataset Descriptives

```{r}
model_df <- read_csv("../model/model_input.csv", show_col_types = F) %>% 
  mutate(rate = n_times_interjected/n_statements,
         gender = case_when(gender=="male"~"Men",
                            gender=="female"~"Women"))

ggplot(model_df, aes(x=parliament_num, y=rate, color=gender)) + 
  geom_point(alpha=0.5) +
  #geom_jitter(width = .25, height = 0, alpha=0.5) +
  facet_wrap(~ party)+
  hrbrthemes::theme_ipsum() +
  scale_color_manual(values=c("Men"="#66CC99", "Women"="#B0AFFF"))+
  theme(axis.title.x = element_text(hjust = 0.5),
        axis.title.y = element_text(hjust = 0.5),
        legend.position="bottom") +
  scale_x_continuous(breaks=c(39,40,41,42,43,44,45,46,47)) +
  labs(y="Rate of Interjection", x="Parliament Number", color="Gender") +
  theme(text=element_text(size=15),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12))

ggsave("../images/rate_of_interject_plot.png", width=8, height=5)
```

```{r}
avg_interject_by_gender<-model_df %>% 
  group_by(parliament_num, gender) %>% 
  summarise(avg_rate=round(mean(rate), 2)) %>% 
  pivot_wider(names_from = gender, values_from = avg_rate) %>% 
  rename("Parliament Number"=parliament_num)

write_csv(avg_interject_by_gender, "../tables/average_interject_by_gender.csv")
```

```{r}
avg_interject_by_party<-model_df %>% 
  group_by(parliament_num, party) %>% 
  summarise(avg_rate=round(mean(rate), 2)) %>% 
  pivot_wider(names_from = party, values_from = avg_rate) %>% 
  rename("Parliament Number"=parliament_num)

write_csv(avg_interject_by_party, "../tables/average_interject_by_party.csv")
```
